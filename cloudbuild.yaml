# DEPRECATED: This Cloud Build configuration is kept for reference only.
# The recommended deployment method is to use the local deploy.sh script.
# See README.md for the current deployment instructions.
#
# To use this file (not recommended):
#   gcloud builds submit --config=cloudbuild.yaml \
#     --substitutions=_OPENAI_SECRET=<secret-name>,_API_SECRET=<secret-name>
#
# Recommended method:
#   export OPENAI_SECRET=<secret-name>
#   export API_SECRET=<secret-name>
#   ./deploy.sh

steps:
  # Build the Docker image
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:latest'
      - '.'
    id: 'build-image'

  # Push to Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - '--all-tags'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}'
    id: 'push-image'
    waitFor: ['build-image']

  # Deploy to Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: bash
    args:
      - '-c'
      - |
        ENV_VARS="GOOGLE_CLOUD_PROJECT=${PROJECT_ID},LOG_BUFFER_SIZE=${_LOG_BUFFER_SIZE}"
        [ -n "${_ADMIN_USER}" ] && ENV_VARS="$${ENV_VARS},ADMIN_USER=${_ADMIN_USER}"
        
        SECRETS="OPENAI_KEY_SECRET_NAME=${_OPENAI_SECRET}:latest,API_KEY_SECRET_NAME=${_API_SECRET}:latest"
        [ -n "${_ADMIN_SECRET}" ] && SECRETS="$${SECRETS},ADMIN_PASSWORD=${_ADMIN_SECRET}:latest"
        
        gcloud run deploy ${_SERVICE_NAME} \
          --image ${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:latest \
          --region ${_REGION} \
          --platform managed \
          --allow-unauthenticated \
          --memory 256Mi \
          --cpu 1 \
          --min-instances 0 \
          --max-instances 5 \
          --timeout 30 \
          --set-env-vars "$${ENV_VARS}" \
          --set-secrets "$${SECRETS}"
    id: 'deploy-cloud-run'
    waitFor: ['push-image']

options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY

substitutions:
  _REGION: 'us-central1'
  _REPO_NAME: 'clotilde-repo'
  _SERVICE_NAME: 'clotilde'
  _OPENAI_SECRET: 'your-openai-secret-name'  # Override with --substitutions=_OPENAI_SECRET=actual-name
  _API_SECRET: 'your-api-secret-name'        # Override with --substitutions=_API_SECRET=actual-name
  _ADMIN_SECRET: ''                          # Optional: admin password secret name for dashboard
  _ADMIN_USER: ''                            # Optional: admin username for dashboard
  _LOG_BUFFER_SIZE: '1000'                   # Optional: max log entries in memory

timeout: '1200s'

